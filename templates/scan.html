<!-- templates/scan.html -->
{% extends "base.html" %}

{% block extra_styles %}
{% endblock %}

{% block content %}
<a href="/" class="back-button">
    ‚Üê Back to Directories
</a>

<div class="scan-header">
    <h1 class="page-title">{{ result.directory }}</h1>
    <p class="page-description">
        Found {{ result.missing_covers }} movie{{ 's' if result.missing_covers != 1 else '' }} 
        without cover art ({{ result.total_files }} total files scanned)
    </p>
</div>

{% if result.movies|length == 0 %}
<div class="alert alert-success">
    <span>‚úì</span>
    <span>All movies in this directory have cover art!</span>
</div>
{% else %}
<div id="movie-list" class="movie-list">
    {% for movie in result.movies %}
    <div class="movie-card" data-movie-id="{{ loop.index0 }}">
        <div class="movie-header">
            <div>
                <h3 class="movie-title">{{ movie.title }}{% if movie.year %} ({{ movie.year }}){% endif %}</h3>
                <p class="movie-filename">{{ movie.filename }}</p>
            </div>
            <div class="movie-status status-loading">
                <div class="spinner"></div>
                <span>Loading...</span>
            </div>
        </div>
        
        <div class="movie-content">
            <!-- TMDB results will be loaded here -->
        </div>
    </div>
    {% endfor %}
</div>

<div class="validation-section">
    <div class="selection-count">
        <strong id="selection-count">0</strong> cover{{ 's' if result.missing_covers != 1 else '' }} selected
    </div>
    <button class="validate-button" id="validate-btn" onclick="downloadCovers()" disabled>
        <span>üíæ</span>
        <span>Download Selected Covers</span>
    </button>
</div>

<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
        <div class="spinner"></div>
        <h3>Downloading covers...</h3>
        <p id="download-progress">0 / 0 completed</p>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
const movies = {{ result.movies | tojson }};
const selections = new Map();

// Load TMDB data for all movies
async function loadMovieData() {
    for (let i = 0; i < movies.length; i++) {
        const movie = movies[i];
        const card = document.querySelector(`[data-movie-id="${i}"]`);
        const statusEl = card.querySelector('.movie-status');
        const contentEl = card.querySelector('.movie-content');
        
        try {
            const response = await fetch('/api/search-movie', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    title: movie.title,
                    year: movie.year
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                statusEl.className = 'movie-status status-ready';
                statusEl.innerHTML = '<span>‚úì</span><span>Ready</span>';
                
                // Display TMDB match and posters using the reusable renderMovieCard function
                contentEl.innerHTML = renderMovieCard(result, i, true);
            } else {
                statusEl.className = 'movie-status status-error';
                statusEl.innerHTML = '<span>‚úó</span><span>Error</span>';
                contentEl.innerHTML = `<div class="error-message">${result.error}</div>`;
            }
        } catch (error) {
            statusEl.className = 'movie-status status-error';
            statusEl.innerHTML = '<span>‚úó</span><span>Error</span>';
            contentEl.innerHTML = `<div class="error-message">Failed to load: ${error.message}</div>`;
        }
    }
}

function selectPoster(movieId, posterId, posterUrl) {
    // Remove previous selection for this movie
    const card = document.querySelector(`[data-movie-id="${movieId}"]`);
    card.querySelectorAll('.poster-option').forEach(el => el.classList.remove('selected'));
    
    // Add selection to clicked poster
    card.querySelectorAll('.poster-option')[posterId].classList.add('selected');
    
    // Store selection
    selections.set(movieId, {
        url: posterUrl,
        path: movies[movieId].cover_path,
        filename: movies[movieId].filename
    });
    
    updateSelectionCount();
}

function skipMovie(movieId) {
    selections.delete(movieId);
    const card = document.querySelector(`[data-movie-id="${movieId}"]`);
    card.querySelectorAll('.poster-option').forEach(el => el.classList.remove('selected'));
    updateSelectionCount();
}

function updateSelectionCount() {
    const count = selections.size;
    document.getElementById('selection-count').textContent = count;
    document.getElementById('validate-btn').disabled = count === 0;
}

async function downloadCovers() {
    const overlay = document.getElementById('loading-overlay');
    const progress = document.getElementById('download-progress');
    const covers = Array.from(selections.values());
    
    overlay.style.display = 'flex';
    
    try {
        const response = await fetch('/api/save-covers', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ covers })
        });
        
        const result = await response.json();
        
        // Redirect back to home with success message
        const message = `Successfully downloaded ${result.success} cover${result.success !== 1 ? 's' : ''}${result.failed > 0 ? ` (${result.failed} failed)` : ''}`;
        window.location.href = `/?success=${encodeURIComponent(message)}`;
    } catch (error) {
        alert('Error downloading covers: ' + error.message);
        overlay.style.display = 'none';
    }
}

// Start loading movie data when page loads
loadMovieData();

function toggleAlternatives(movieId) {
    const list = document.getElementById(`alternatives-${movieId}`);
    list.classList.toggle('show');
    
    const toggle = event.currentTarget;
    const arrow = toggle.lastElementChild;
    arrow.textContent = list.classList.contains('show') ? '‚ñ≤' : '‚ñº';
}

const escapeHtml = unsafe => {
  return unsafe
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
};

/**
 * Renders the movie card HTML with movie details, poster grid, and optionally alternatives
 * @param {Object} result - The API response containing movie data
 * @param {number} movieId - The movie ID for event handlers
 * @param {boolean} showAlternatives - Whether to show the alternatives section (default: true)
 * @returns {string} HTML string for the movie card content
 */
function renderMovieCard(result, movieId, showAlternatives = true) {
    return `
        <div class="tmdb-info">
            <div class="tmdb-match">
                ${result.movie.poster_path ? `<img src="https://image.tmdb.org/t/p/w185${result.movie.poster_path}" class="tmdb-poster" alt="Poster">` : ''}
                <div class="tmdb-details">
                    <h4>${escapeHtml(result.movie.title)} (${result.movie.year || 'N/A'}) ${result.movie.vote_average ? '‚≠ê ' + result.movie.vote_average.toFixed(1) : ''}</h4>
                    <p class="tmdb-overview">${result.movie.overview ? escapeHtml(result.movie.overview.substring(0, 150)) + (result.movie.overview.length > 150 ? '...' : '') : 'No overview available'}</p>
                </div>
            </div>
        </div>
        
        ${showAlternatives && result.alternatives && result.alternatives.length > 0 ? `
            <div class="alternatives-section">
                <button class="alternatives-toggle" onclick="toggleAlternatives(${movieId})">
                    <span>üîç</span>
                    <span>Not the right movie? Click to see ${result.alternatives.length} alternative${result.alternatives.length > 1 ? 's' : ''}</span>
                    <span style="margin-left: auto">‚ñº</span>
                </button>
                <div class="alternatives-list" id="alternatives-${movieId}">
                    ${result.alternatives.map(alt => `
                        <div class="alternative-option" onclick="selectAlternative(${movieId}, ${alt.id})">
                            ${alt.poster_path ? `<img src="https://image.tmdb.org/t/p/w92${alt.poster_path}" class="alternative-poster" alt="${escapeHtml(alt.title)}">` : '<div class="alternative-poster"></div>'}
                            <div class="alternative-info">
                                <div class="alternative-title">${escapeHtml(alt.title)} (${escapeHtml(alt.year) || 'N/A'})</div>
                                <div class="alternative-meta">
                                    ${alt.vote_average ? '‚≠ê ' + alt.vote_average.toFixed(1) : ''} 
                                    ${alt.overview ? '‚Ä¢ ' + escapeHtml(alt.overview.substring(0, 80)) + '...' : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : ''}
        
        <div class="selection-header">
            <strong>Select a cover:</strong>
            <button class="skip-button" onclick="skipMovie(${movieId})">Skip this movie</button>
        </div>
        
        ${
            Array.isArray(result.movie.posters) && result.movie.posters.length > 0
            ? `<div class="poster-grid" id="poster-grid-${movieId}">
                ${result.movie.posters.map((poster, idx) => `
                    <div class="poster-option" onclick="selectPoster(${movieId}, ${idx}, '${escapeHtml(poster.url_full)}')">
                        <img src="${escapeHtml(poster.url_thumb)}" alt="Poster option ${idx + 1}">
                        <div class="poster-overlay">
                            <div class="check-icon">‚úì</div>
                        </div>
                    </div>
                `).join('')}
            </div>`
            : `<div class="no-posters-message">No posters available for this movie.</div>`
        }
    `;
}

let loading = false;
async function selectAlternative(movieId, tmdbId) {
    if(loading) return;
    const card = document.querySelector(`[data-movie-id="${movieId}"]`);
    const contentEl = card.querySelector('.movie-content');
    
    // Show loading
    contentEl.innerHTML = '<div class="loading-container"><div class="spinner"></div><p>Loading alternative movie...</p></div>';
    
    try {
        // Fetch details for selected alternative
        loading = true;
        const response = await fetch(`/api/get-movie-details/${tmdbId}`);
        const result = await response.json();
        
        if (result.success) {
            // Update the display with new movie using the reusable renderMovieCard function
            // Don't show alternatives section when selecting an alternative
            contentEl.innerHTML = renderMovieCard(result, movieId, false);
            
            // Clear any previous selection for this movie
            // Remove 'selected' class from all poster options in this card
            const posterOptions = card.querySelectorAll('.poster-option.selected');
            posterOptions.forEach(el => el.classList.remove('selected'));
            updateSelectionCount();
        } else {
            contentEl.innerHTML = `<div class="error-message">Failed to load alternative: ${escapeHtml(result.error || 'Unknown error occurred')}</div>`;
        }
    } catch (error) {
        contentEl.innerHTML = `<div class="error-message">Error loading alternative: ${escapeHtml(error?.message || 'Unknown error occurred')}</div>`;
    } finally {
        loading = false;
    }
}
</script>
{% endblock %}